This repository contains scripts needed for analyzing uClibc using TypeChef and FARCE to automatically extract configuration constraints from them.

What you need
=============
- Our fork of [TypeChef](https://github.com/snadi/TypeChef). This includes a modified version of TypeChef which captures the necessary information during lexing and parsing needed to compute constraints later. 
- Our [FARCE](https://bitbucket.org/tberger/farce) infrastructure. This computes the constraints based on TypeChef's outputs, and has the tools needed to compare constraints as well.
- The following [system headers](http://www.informatik.uni-marburg.de/~kaestner/tmp/includes-redhat.tar.bz2)

Steps
=====
- In the TypeChef directory, run "sbt mkrun" which will generate a typechef.sh script that has all the necessary classpaths on your computer. Make sure that the "typechefDir=" in jcpp.sh is set to the path where you checked out TypeChef.
- In the FARCE directory, run "sbt mkrun" which will generare a run.sh script that has all the necessary classpaths on your computer. Make sure that the "farceCommand=" in the farceAnalysis.sh and prepare.sh scripts is set to the right path of the run.sh script in your farce directory.
-This repository does not contain uClibc's actual source code. uCLibc/ only contains the results of the analysis to allow easy re-running of farce code without having to re-run TypeChef. We analyzed uClibc [v0.9.33.2](http://www.uclibc.org/downloads/uClibc-0.9.33.2.tar.bz2) but you can use any other version. You do not necessarily have to put the uClibc source code in "uCLibc", you can check it out to any folder. Just make sure you put the right path for it in "srcPath" in the analyze.sh and analyzeSingle scripts.
- After you checkout everything, and setup the right paths, run "prepare.sh" to extract the file pc and apply some necessary patches to uClibc. The patches are some workarounds to limitations in the preprocessor and parser (e.g., unsupported number formats etc.)
- Make sure that the systems headers above have been downloaded, and that you have the right paths to them in the redhat.properties file
- Run "analyze.sh" -- this will analyze the filelist sequentially. If you want to parallelize the process, you can use the parallelize script. Make sure you adjust the number of processes according to the capabilities of your machine. If you just want to run a single file ./analyzeSingleFile <fileName without uClibc/ and without .c> x86_64
- After TypeChef finishes the analysis, run "farceAnalysis.sh" which will create the constraints and formulas, and will also run "compareModels.sh" to compare the existing variability model to the extracted constraints and vice versa
	* All the paths used in farce are in the uclibc.properties file. Feel free to change them as you would like, but make sure to update the actual directory structure accordingly

Results
=======
- There are X types of files generated by TypeChef for each analyzed file:
	* .pi: contains the file's content after expanding all #includes and macros
	* .c.xml: xml representation of parser and type errors
	* .interface: xml representation of symbol table (imports and exports) for this file
	* .nested: block presence conditions which appear in this file
	* .hasherr: #error conditions
	* .hashwarn: #warn conditions (not used at the moment)

- Constraints and their formulas are outputted by FARCE as follows:
	* Preprocessor Constraints are in the output/PreprocessorErrors directory
	* Parser consttraints are in the output/ParserErrors directory
	* Type constraints are in the output/TypeErrors directory
	* Linker Constraints are in the output/Linker directory
	* Feature effect for build systems are in the output/FilePcs directory
	* Feature effect constraints for the whole code are in output/FeatureEffect directory

- Comparison results are as follows:
	* output/Comparison/FeatureModelVsCode/hierarchy.csv is a spreadsheet with each constraints and a "1" for the code analysis(es) it can be recovered from
	* output/Comparison/FeatureModelVsCode/hierarchyStats.txt prints out a list of the constraints that were not found and a summary of the stats at the end.
	* Similar files for the two above exist for the cross tree constraints
	* output/Comparison/CodeVsFeatureModel compares each set of extractd code constraints to the overall variability model formula and outputs similar csv and stats files for each code analysis.

Notes
=====

- File pcs have been extracted manually.
- File list extracted from make output after configuring for arch x86_64
- Feature model for x86_64 arch extracted using LVAT.. export ARCH=X86_64 then run lvat with extras/Configs/Config.in
- There are a couple of files which failed to lex or parse using TypeChef, and which were removed from the analysis (will not appear in the filelist). We are working on fixing these.
- Note that in uClibc changes the included header files depending on the selection of certain features. This change happens in the build system. To mimic this, we had to change the code for some of the header files such that the selection happens in the C code which the TypeChef parser can deal with. This is why you will find the header files in this repository under the uClibc folder. It is advised that you use these changed header file to avoid false positives in the detected errors.


Credits
=======
A lot of the scripts and setup for running TypeChef have been adapted from [Typechef-BusyboxAnalysis](https://github.com/ckaestne/TypeChef-BusyboxAnalysis). 

You may also want to look at that repository for further analyses that may be done.


Project Members
===============
- [Sarah Nadi](http://swag.uwaterloo.ca/~snadi)
- [Thorsten Berger](http://www.itu.dk/people/thbe/)
- [Christian KÃ¤stner](www.cs.cmu.edu/~ckaestne/)
- [Krzysztof Czarnecki](gsd.uwaterloo.ca/kczarnec)

Contact Us
==========
If you have any questions or clarifications, please contact one of us.



